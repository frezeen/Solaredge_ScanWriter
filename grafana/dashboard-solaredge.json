{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "influxdb",
          "uid": "ff27vpmruzxtsc"
        },
        "enable": false,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "target": {
          "limit": 100,
          "matchAny": false,
          "tags": [],
          "type": "dashboard"
        },
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": 0,
  "links": [],
  "panels": [
    {
      "datasource": {
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "center",
            "cellOptions": {
              "type": "auto"
            },
            "filterable": false,
            "footer": {
              "reducers": []
            },
            "inspect": false,
            "wrapHeaderText": false,
            "wrapText": false
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 22,
        "x": 0,
        "y": 0
      },
      "id": 171,
      "options": {
        "cellHeight": "sm",
        "enablePagination": false,
        "showHeader": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "query": "from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: -1h)\r\n  |> filter(fn: (r) => r._measurement == \"realtime\")\r\n  |> filter(fn: (r) => r._field == \"Inverter_Text\")\r\n  |> filter(fn: (r) => \r\n      r.endpoint == \"Manufacturer\" or \r\n      r.endpoint == \"Model\" or \r\n      r.endpoint == \"Serialnumber\" or \r\n      r.endpoint == \"Version\"\r\n  )\r\n  |> last()\r\n  |> group()\r\n  |> pivot(rowKey: [], columnKey: [\"endpoint\"], valueColumn: \"_value\")\r\n  |> drop(columns: [\"_start\", \"_stop\", \"_measurement\", \"_field\", \"device_id\", \"unit\"])",
          "refId": "A"
        }
      ],
      "title": "",
      "transparent": true,
      "type": "table"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 2,
        "x": 22,
        "y": 0
      },
      "id": 26,
      "options": {
        "bgColor": "transparent",
        "clockType": "24 hour",
        "countdownSettings": {
          "endCountdownTime": "2021-10-12T05:34:44+02:00",
          "endText": "00:00:00",
          "invalidValueText": "invalid value",
          "noValueText": "no value found",
          "queryCalculation": "last",
          "source": "input"
        },
        "countupSettings": {
          "beginCountupTime": "2022-06-01T23:43:26+02:00",
          "beginText": "00:00:00",
          "invalidValueText": "invalid value",
          "noValueText": "no value found",
          "queryCalculation": "last",
          "source": "input"
        },
        "dateSettings": {
          "dateFormat": "DD MMMM YYYY",
          "fontSize": "14px",
          "fontWeight": "bold",
          "locale": "it",
          "showDate": true
        },
        "descriptionSettings": {
          "descriptionText": "",
          "fontSize": "12px",
          "fontWeight": "normal",
          "noValueText": "no description found",
          "source": "none"
        },
        "fontMono": true,
        "mode": "time",
        "refresh": "sec",
        "timeSettings": {
          "fontSize": "15px",
          "fontWeight": "normal"
        },
        "timezone": "",
        "timezoneSettings": {
          "fontSize": "12px",
          "fontWeight": "normal",
          "showTimezone": false,
          "zoneFormat": "offsetAbbv"
        }
      },
      "pluginVersion": "2.1.9",
      "targets": [
        {
          "refId": "A"
        }
      ],
      "title": "",
      "transparent": true,
      "type": "grafana-clock-panel"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "displayName": "Produzione",
          "links": [],
          "mappings": [],
          "max": 6000,
          "min": 0,
          "thresholds": {
            "mode": "percentage",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              },
              {
                "color": "orange",
                "value": 50
              },
              {
                "color": "dark-red",
                "value": 75
              }
            ]
          },
          "unit": "watt"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 9,
        "w": 7,
        "x": 0,
        "y": 3
      },
      "hideTimeOverride": true,
      "id": 10,
      "options": {
        "minVizHeight": 75,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": true,
        "sizing": "auto",
        "text": {}
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: -1m)\r\n  |> filter(fn: (r) =>\r\n    r._measurement == \"realtime\" and\r\n    r._field == \"Inverter\" and\r\n    r.endpoint == \"Power Ac\" and\r\n    r.unit == \"W\"\r\n  )\r\n  |> group(columns: [])\r\n  |> last()\r\n  |> map(fn: (r) => ({ r with _time: date.truncate(t: r._time, unit: 1s) }))\r\n  |> rename(columns: {_value: \"Produzione\"})\r\n  |> keep(columns: [\"_time\",\"Produzione\"])\r\n  |> yield(name: \"produzione_last_W\")",
          "refId": "Produzione"
        }
      ],
      "timeFrom": "0d/d",
      "title": "",
      "transparent": true,
      "type": "gauge"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "displayName": "Prelievo - Immissione",
          "links": [],
          "mappings": [],
          "max": 5000,
          "min": -5000,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-red",
                "value": 0
              },
              {
                "color": "dark-green",
                "value": 0
              }
            ]
          },
          "unit": "watt"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 9,
        "w": 8,
        "x": 7,
        "y": 3
      },
      "hideTimeOverride": true,
      "id": 14,
      "options": {
        "minVizHeight": 75,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": true,
        "sizing": "auto",
        "text": {}
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: -1m)\r\n  |> filter(fn: (r) =>\r\n    r._measurement == \"realtime\" and\r\n    r._field == \"Meter\" and\r\n    r.endpoint == \"Power\" and\r\n    r.unit == \"W\"\r\n  )\r\n  |> group(columns: [])         // una sola serie\r\n  |> last()\r\n  |> map(fn: (r) => ({ r with _time: date.truncate(t: r._time, unit: 1s) }))\r\n  |> rename(columns: {_value: \"Prelievo Immissione\"})\r\n  |> keep(columns: [\"_time\", \"Prelievo Immissione\"])\r\n  |> yield(name: \"meter_power_last_W\")",
          "refId": "Prelievo - Immissione"
        }
      ],
      "timeFrom": "0d/d",
      "title": "",
      "transparent": true,
      "type": "gauge"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "displayName": "Consumo",
          "mappings": [],
          "max": 4300,
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "orange",
                "value": 1000
              },
              {
                "color": "red",
                "value": 2000
              },
              {
                "color": "dark-red",
                "value": 3000
              }
            ]
          },
          "unit": "watt"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 9,
        "w": 7,
        "x": 15,
        "y": 3
      },
      "hideTimeOverride": true,
      "id": 12,
      "options": {
        "minVizHeight": 75,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "/^Consumo$/",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": true,
        "sizing": "auto",
        "text": {}
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: -1m)\r\n  |> filter(fn: (r) =>\r\n    r._measurement == \"realtime\" and\r\n    r._field == \"Inverter\" and\r\n    r.endpoint == \"Power Ac\" and\r\n    r.unit == \"W\"\r\n  )\r\n  |> group(columns: [])\r\n  |> last()\r\n  |> map(fn: (r) => ({ r with _time: date.truncate(t: r._time, unit: 1s) }))\r\n  |> rename(columns: {_value: \"Produzione\"})\r\n  |> keep(columns: [\"_time\",\"Produzione\"])\r\n  |> yield(name: \"produzione_last_W\")",
          "refId": "Produzione"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: -1m)\r\n  |> filter(fn: (r) =>\r\n    r._measurement == \"realtime\" and\r\n    r._field == \"Meter\" and\r\n    r.endpoint == \"Power\" and\r\n    r.unit == \"W\"\r\n  )\r\n  |> group(columns: [])         // una sola serie\r\n  |> last()\r\n  |> map(fn: (r) => ({ r with _time: date.truncate(t: r._time, unit: 1s) }))\r\n  |> rename(columns: {_value: \"Prelievo Immissione\"})\r\n  |> keep(columns: [\"_time\", \"Prelievo Immissione\"])\r\n  |> yield(name: \"meter_power_last_W\")",
          "refId": "Prelievo Immissione"
        }
      ],
      "timeFrom": "0d/d",
      "title": "",
      "transformations": [
        {
          "id": "calculateField",
          "options": {
            "alias": "Consumo",
            "binary": {
              "left": {
                "matcher": {
                  "id": "byName",
                  "options": "Produzione"
                }
              },
              "operator": "-",
              "right": {
                "matcher": {
                  "id": "byName",
                  "options": "Prelievo Immissione"
                }
              }
            },
            "cumulative": {
              "field": "Produzione",
              "reducer": "sum"
            },
            "mode": "binary",
            "reduce": {
              "include": [
                "Produzione",
                "Prelievo Immissione"
              ],
              "reducer": "step"
            },
            "replaceFields": true,
            "window": {
              "field": "Produzione",
              "reducer": "mean",
              "windowAlignment": "trailing",
              "windowSize": 0.1,
              "windowSizeMode": "percentage"
            }
          }
        },
        {
          "id": "filterFieldsByName",
          "options": {
            "include": {
              "names": [
                "Consumo"
              ]
            }
          }
        }
      ],
      "transparent": true,
      "type": "gauge"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "decimals": 0,
          "displayName": "Temperatura",
          "mappings": [],
          "max": 100,
          "min": 0,
          "thresholds": {
            "mode": "percentage",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "dark-red",
                "value": 50
              }
            ]
          },
          "unit": "celsius"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 5,
        "w": 2,
        "x": 22,
        "y": 3
      },
      "hideTimeOverride": true,
      "id": 48,
      "maxDataPoints": 100,
      "options": {
        "minVizHeight": 90,
        "minVizWidth": 75,
        "orientation": "horizontal",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": true,
        "sizing": "manual",
        "text": {}
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "alias": "Temperatura",
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "groupBy": [],
          "measurement": "inverter",
          "orderByTime": "ASC",
          "policy": "default",
          "query": "import \"timezone\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: -1m)\r\n  |> filter(fn: (r) =>\r\n    r._measurement == \"realtime\" and\r\n    r._field == \"Inverter\" and\r\n    r.endpoint == \"Temperature\" and\r\n    r.unit == \"°C\"\r\n    // opzionale: r.device_id == \"TUO_MODELLO\"\r\n  )\r\n  |> group(columns: [])      // una sola serie\r\n  |> last()\r\n  |> keep(columns: [\"_time\", \"_value\"])\r\n  |> yield(name: \"inverter_temperature_last_C\")",
          "rawQuery": true,
          "refId": "Temperatura",
          "resultFormat": "time_series",
          "select": [
            [
              {
                "params": [
                  "temperature"
                ],
                "type": "field"
              },
              {
                "params": [],
                "type": "last"
              }
            ]
          ],
          "tags": []
        }
      ],
      "timeFrom": "0d/d",
      "title": "",
      "transparent": true,
      "type": "gauge"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "decimals": 0,
          "displayName": "Voltaggio",
          "mappings": [],
          "max": 480,
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-red",
                "value": 0
              },
              {
                "color": "green",
                "value": 150
              },
              {
                "color": "dark-red",
                "value": 440
              }
            ]
          },
          "unit": "volt"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 5,
        "w": 2,
        "x": 22,
        "y": 8
      },
      "hideTimeOverride": true,
      "id": 184,
      "maxDataPoints": 100,
      "options": {
        "minVizHeight": 90,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": true,
        "sizing": "manual",
        "text": {}
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "alias": "Volt",
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "groupBy": [],
          "measurement": "inverter",
          "orderByTime": "ASC",
          "policy": "default",
          "query": "import \"timezone\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: -1m)\r\n  |> filter(fn: (r) =>\r\n    r._measurement == \"realtime\" and\r\n    r._field == \"Inverter\" and\r\n    r.endpoint == \"Voltage Dc\" and\r\n    r.unit == \"V\"\r\n  )\r\n  |> group(columns: [])\r\n  |> last()\r\n  |> keep(columns: [\"_time\", \"_value\"])\r\n  |> yield(name: \"voltage_dc_last_V\")",
          "rawQuery": true,
          "refId": "Voltaggio",
          "resultFormat": "time_series",
          "select": [
            [
              {
                "params": [
                  "voltage_dc"
                ],
                "type": "field"
              },
              {
                "params": [],
                "type": "last"
              }
            ]
          ],
          "tags": []
        }
      ],
      "timeFrom": "0d/d",
      "title": "",
      "transparent": true,
      "type": "gauge"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "light-yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 3,
        "x": 0,
        "y": 12
      },
      "hideTimeOverride": true,
      "id": 44,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "/^produzione_oggi_wh$/",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "alias": "Produzione di oggi",
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "groupBy": [
            {
              "params": [
                "$__interval"
              ],
              "type": "time"
            },
            {
              "params": [
                "null"
              ],
              "type": "fill"
            }
          ],
          "hide": false,
          "orderByTime": "ASC",
          "policy": "default",
          "query": "import \"timezone\"\nimport \"date\"\noption location = timezone.location(name: \"Europe/Rome\")\n\nstart = date.truncate(t: now(), unit: 1d)\nstop  = date.add(d: 1d, to: start)\n\ndailyDeltaWh = (tables=<-) => {\n  f = tables\n    |> first()\n    |> keep(columns: [\"device_id\", \"_value\"])\n    |> set(key: \"kind\", value: \"start\")\n\n  l = tables\n    |> last()\n    |> keep(columns: [\"device_id\", \"_value\"])\n    |> set(key: \"kind\", value: \"end\")\n\n  return union(tables: [f, l])\n    |> pivot(rowKey: [\"device_id\"], columnKey: [\"kind\"], valueColumn: \"_value\")\n    |> map(fn: (r) => ({ r with _value: float(v: r.end) - float(v: r.start) }))\n    |> map(fn: (r) => ({ r with _value: if r._value < 0.0 then 0.0 else r._value }))\n    |> group(columns: [])\n    |> sum(column: \"_value\")\n}\n\nfrom(bucket: \"Solaredge_Realtime\")\n  |> range(start: start, stop: stop)\n  |> filter(fn: (r) =>\n    r._measurement == \"realtime\" and\n    r._field == \"Inverter\" and\n    r.endpoint == \"Energy Total\" and\n    r.unit == \"Wh\"\n  )\n  |> group(columns: [\"device_id\"])\n  |> dailyDeltaWh()\n  |> map(fn: (r) => ({\n    r with\n    _time: date.truncate(\n      t: if date.millisecond(t: now()) >= 500 then date.add(d: 1s, to: now()) else now(),\n      unit: 1s\n    )\n  }))\n  |> rename(columns: {_value: \"produzione_oggi_wh\"})\n  |> keep(columns: [\"_time\",\"produzione_oggi_wh\"])\n  |> yield(name: \"produzione_fotovoltaica_oggi_wh\")",
          "queryType": "randomWalk",
          "rawQuery": true,
          "refId": "Produzione",
          "resultFormat": "time_series",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "field"
              },
              {
                "params": [],
                "type": "mean"
              }
            ]
          ],
          "tags": []
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "0d/d",
      "title": "Produzione",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "light-yellow",
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "super-light-blue",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 3,
        "x": 3,
        "y": 12
      },
      "hideTimeOverride": true,
      "id": 67,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [],
          "fields": "/^_value$/",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"array\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nstart = date.truncate(t: now(), unit: 1d)\r\n\r\n// Dati Export Energy\r\ndata = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: start)\r\n  |> filter(fn: (r) =>\r\n    r._measurement == \"realtime\" and\r\n    r._field == \"Meter\" and\r\n    r.endpoint == \"Export Energy Active\" and\r\n    r.unit == \"Wh\"\r\n  )\r\n\r\n// Primo e ultimo valore\r\nfirst_record = data |> first() |> findRecord(fn: (key) => true, idx: 0)\r\nlast_record = data |> last() |> findRecord(fn: (key) => true, idx: 0)\r\n\r\n// Calcolo immissione\r\nimmissione_wh = last_record._value - first_record._value\r\n\r\n// Output\r\narray.from(rows: [{\r\n  _time: date.truncate(t: now(), unit: 1s),\r\n  _field: \"immissione_oggi_wh\",\r\n  _value: immissione_wh,\r\n  start_wh: first_record._value,\r\n  end_wh: last_record._value\r\n}])\r\n  |> yield(name: \"immissione_oggi_Wh\")",
          "refId": "Immissione"
        }
      ],
      "timeFrom": "0d/d",
      "title": "Immissione",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "light-yellow",
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "semi-dark-orange",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 3,
        "x": 6,
        "y": 12
      },
      "hideTimeOverride": true,
      "id": 66,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [],
          "fields": "/^_value$/",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"array\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nstart = date.truncate(t: now(), unit: 1d)\r\n\r\n// Produzione: ultimo - primo\r\ndata_prod = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: start)\r\n  |> filter(fn: (r) =>\r\n      r._measurement == \"realtime\" and\r\n      r._field == \"Inverter\" and\r\n      r.endpoint == \"Energy Total\"\r\n  )\r\n  |> filter(fn: (r) => exists r._value)\r\n\r\nfirst_prod = data_prod |> first() |> findRecord(fn: (key) => true, idx: 0)\r\nlast_prod = data_prod |> last() |> findRecord(fn: (key) => true, idx: 0)\r\nprod_value = last_prod._value - first_prod._value\r\n\r\n// Import: ultimo - primo\r\ndata_imp = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: start)\r\n  |> filter(fn: (r) =>\r\n      r._measurement == \"realtime\" and\r\n      r._field == \"Meter\" and\r\n      r.endpoint == \"Import Energy Active\"\r\n  )\r\n  |> filter(fn: (r) => exists r._value)\r\n\r\nfirst_imp = data_imp |> first() |> findRecord(fn: (key) => true, idx: 0)\r\nlast_imp = data_imp |> last() |> findRecord(fn: (key) => true, idx: 0)\r\nimp_value = last_imp._value - first_imp._value\r\n\r\n// Export: ultimo - primo\r\ndata_exp = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: start)\r\n  |> filter(fn: (r) =>\r\n      r._measurement == \"realtime\" and\r\n      r._field == \"Meter\" and\r\n      r.endpoint == \"Export Energy Active\"\r\n  )\r\n  |> filter(fn: (r) => exists r._value)\r\n\r\nfirst_exp = data_exp |> first() |> findRecord(fn: (key) => true, idx: 0)\r\nlast_exp = data_exp |> last() |> findRecord(fn: (key) => true, idx: 0)\r\nexp_value = last_exp._value - first_exp._value\r\n\r\n// Consumo = Import + Produzione - Export\r\nconsumo_wh = imp_value + prod_value - exp_value\r\n\r\n// Output\r\narray.from(rows: [{\r\n  _time: now(),\r\n  _field: \"consumo_oggi_wh\",\r\n  _value: consumo_wh,\r\n  import_wh: imp_value,\r\n  produzione_wh: prod_value,\r\n  export_wh: exp_value\r\n}])\r\n  |> yield(name: \"consumo_totale_oggi_Wh\")",
          "refId": "Consumo"
        }
      ],
      "timeFrom": "0d/d",
      "title": "Consumo",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "light-yellow",
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-red",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 3,
        "x": 9,
        "y": 12
      },
      "hideTimeOverride": true,
      "id": 68,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "horizontal",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "/^prelievo_oggi_kwh$/",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"array\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\ntoday_start = date.truncate(t: now(), unit: 1d)\r\n\r\n// Ottieni prima e ultima lettura\r\ndata = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: today_start)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"realtime\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"Import Energy Active\")\r\n  |> filter(fn: (r) => exists r._value)\r\n\r\nfirst_value = data\r\n  |> first()\r\n  |> findRecord(fn: (key) => true, idx: 0)\r\n\r\nlast_value = data\r\n  |> last()\r\n  |> findRecord(fn: (key) => true, idx: 0)\r\n\r\n// Calcola la differenza\r\narray.from(rows: [{\r\n  _time: now(),\r\n  _field: \"prelievo_oggi_kwh\",\r\n  prelievo_oggi_kwh: last_value._value - first_value._value,\r\n  prima_lettura: first_value._value,\r\n  ultima_lettura: last_value._value\r\n}])",
          "refId": "Prelievo"
        }
      ],
      "timeFrom": "0d/d",
      "title": "Prelievo",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "light-yellow",
            "mode": "thresholds"
          },
          "mappings": [],
          "max": 100,
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-red",
                "value": 0
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 3,
        "x": 12,
        "y": 12
      },
      "hideTimeOverride": true,
      "id": 86,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "/^Perc_Prelievo_OGGI$/",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "value",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"array\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\ntoday_start = date.truncate(t: now(), unit: 1d)\r\n\r\n// Energia importata\r\ndata_importata = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: today_start)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"realtime\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"Import Energy Active\")\r\n  |> filter(fn: (r) => exists r._value)\r\n\r\nfirst_importata = data_importata |> first() |> findRecord(fn: (key) => true, idx: 0)\r\nlast_importata = data_importata |> last() |> findRecord(fn: (key) => true, idx: 0)\r\nimportata_value = last_importata._value - first_importata._value\r\n\r\n// Energia prodotta\r\ndata_prodotta = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: today_start)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"realtime\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Inverter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"Energy Total\")\r\n  |> filter(fn: (r) => exists r._value)\r\n\r\nfirst_prodotta = data_prodotta |> first() |> findRecord(fn: (key) => true, idx: 0)\r\nlast_prodotta = data_prodotta |> last() |> findRecord(fn: (key) => true, idx: 0)\r\nprodotta_value = last_prodotta._value - first_prodotta._value\r\n\r\n// Energia esportata\r\ndata_esportata = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: today_start)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"realtime\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"Export Energy Active\")\r\n  |> filter(fn: (r) => exists r._value)\r\n\r\nfirst_esportata = data_esportata |> first() |> findRecord(fn: (key) => true, idx: 0)\r\nlast_esportata = data_esportata |> last() |> findRecord(fn: (key) => true, idx: 0)\r\nesportata_value = last_esportata._value - first_esportata._value\r\n\r\n// Calcoli finali\r\nautoconsumo = prodotta_value - esportata_value\r\nconsumo_totale = importata_value + autoconsumo\r\nperc_prelievo = if consumo_totale > 0.0 then (importata_value / consumo_totale) * 100.0 else 0.0\r\n\r\n// Risultato\r\narray.from(rows: [{\r\n  _time: now(),\r\n  _field: \"percentuale_prelievo\",\r\n  autoconsumo_wh: autoconsumo,\r\n  consumo_totale_wh: consumo_totale,\r\n  Perc_Prelievo_OGGI: perc_prelievo,\r\n  Prelievo_Wh_Debug: importata_value,\r\n  Autoconsumo_Wh_Debug: autoconsumo,\r\n  Consumo_Totale_Wh_Debug: consumo_totale\r\n}])",
          "refId": "% Prelievo"
        }
      ],
      "timeFrom": "0d/d",
      "title": "Percentuale Prelievo",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "dark-red",
            "mode": "fixed"
          },
          "decimals": 3,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "#37872D",
                "value": 0
              }
            ]
          },
          "unit": "currencyEUR"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 3,
        "x": 15,
        "y": 12
      },
      "hideTimeOverride": true,
      "id": 101,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "/.*/",
          "limit": 2,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"array\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nstart = date.truncate(t: now(), unit: 1d)\r\nmonth_start = date.truncate(t: now(), unit: 1mo)\r\n\r\n// Recupera prezzo PUN\r\nprezzo_pun = from(bucket: \"GME\")\r\n  |> range(start: month_start)\r\n  |> filter(fn: (r) => r._measurement == \"gme_monthly_avg\" and r._field == \"pun_kwh_avg\")\r\n  |> last()\r\n  |> findRecord(fn: (key) => true, idx: 0)\r\n\r\n// Calcolo prelievo\r\nbase = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: start)\r\n  |> filter(fn: (r) => r._measurement == \"realtime\" and r._field == \"Meter\" and r.endpoint == \"Import Energy Active\" and r.unit == \"Wh\")\r\n\r\nfirst = base |> filter(fn: (r) => exists r._value and r._value > 0.0) |> sort(columns: [\"_time\"]) |> limit(n: 1) |> findRecord(fn: (key) => true, idx: 0)\r\nlast = base |> last() |> findRecord(fn: (key) => true, idx: 0)\r\n\r\nprelievo = if (last._value - first._value) < 0.0 then 0.0 else (last._value - first._value)\r\ncosto = (prelievo / 1000.0) * prezzo_pun._value\r\n\r\narray.from(rows: [{PUN: prezzo_pun._value, Costo: costo}])\r\n",
          "refId": "Costo Prelievo"
        }
      ],
      "timeFrom": "0d/d",
      "title": "Costo Prelievo",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "decimals": 0,
          "mappings": [
            {
              "options": {
                "1": {
                  "index": 8,
                  "text": "Aus"
                },
                "2": {
                  "color": "transparent",
                  "index": 7,
                  "text": "Modalità notturna (disattivata)"
                },
                "3": {
                  "index": 6,
                  "text": "Processo di avvio"
                },
                "4": {
                  "color": "green",
                  "index": 5,
                  "text": "Produzione"
                },
                "5": {
                  "index": 4,
                  "text": "Limitato"
                },
                "6": {
                  "index": 3,
                  "text": "Spento"
                },
                "7": {
                  "index": 2,
                  "text": "Errore!"
                },
                "8": {
                  "index": 1,
                  "text": "Manutenzione"
                }
              },
              "type": "value"
            },
            {
              "options": {
                "match": "null",
                "result": {
                  "index": 0,
                  "text": "N/A"
                }
              },
              "type": "special"
            }
          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "rgb(240, 237, 236)",
                "value": 0
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Efficienza"
            },
            "properties": [
              {
                "id": "unit",
                "value": "percent"
              },
              {
                "id": "decimals",
                "value": 1
              },
              {
                "id": "displayName",
                "value": "Efficienza"
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "percentage",
                  "steps": [
                    {
                      "color": "dark-red",
                      "value": 0
                    },
                    {
                      "color": "semi-dark-green",
                      "value": 0
                    }
                  ]
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 3,
        "w": 4,
        "x": 18,
        "y": 12
      },
      "hideTimeOverride": true,
      "id": 20,
      "maxDataPoints": 100,
      "options": {
        "colorMode": "background",
        "fieldOptions": {
          "calcs": [
            "mean"
          ]
        },
        "graphMode": "area",
        "justifyMode": "center",
        "orientation": "horizontal",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "/^_value$/",
          "values": false
        },
        "showPercentChange": false,
        "text": {
          "valueSize": 25
        },
        "textMode": "value",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: -30m)\r\n  |> filter(fn: (r) =>\r\n    r._measurement == \"realtime\" and\r\n    r._field == \"Inverter\" and\r\n    r.endpoint == \"Status\"\r\n  )\r\n  |> group(columns: [\"device_id\"])\r\n  |> last()\r\n  |> keep(columns: [\"endpoint\",\"_value\"])\r\n  |> yield(name: \"inverter_status\")",
          "refId": "Stato"
        }
      ],
      "timeFrom": "0d/d",
      "title": "Stato Inverter",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "decimals": 2,
          "displayName": "Amperaggio",
          "mappings": [],
          "max": 15,
          "min": 0,
          "noValue": "0 A",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "red",
                "value": 0
              },
              {
                "color": "green",
                "value": 0.1
              }
            ]
          },
          "unit": "amp"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 5,
        "w": 2,
        "x": 22,
        "y": 13
      },
      "hideTimeOverride": true,
      "id": 63,
      "maxDataPoints": 100,
      "options": {
        "minVizHeight": 90,
        "minVizWidth": 75,
        "orientation": "horizontal",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": true,
        "sizing": "auto",
        "text": {}
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "alias": "Volt",
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "groupBy": [],
          "measurement": "inverter",
          "orderByTime": "ASC",
          "policy": "default",
          "query": "import \"timezone\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: -1m)\r\n  |> filter(fn: (r) =>\r\n    r._measurement == \"realtime\" and\r\n    r._field == \"Inverter\" and\r\n    r.endpoint == \"Current Dc\" and\r\n    r.unit == \"A\"\r\n    // opzionale: r.device_id == \"TUO_INVERTER\"\r\n  )\r\n  |> group(columns: [])\r\n  |> last()\r\n  |> keep(columns: [\"_time\", \"_value\"])\r\n  |> yield(name: \"current_dc_last_A\")",
          "rawQuery": true,
          "refId": "Amperaggio",
          "resultFormat": "time_series",
          "select": [
            [
              {
                "params": [
                  "voltage_dc"
                ],
                "type": "field"
              },
              {
                "params": [],
                "type": "last"
              }
            ]
          ],
          "tags": []
        }
      ],
      "timeFrom": "0d/d",
      "title": "",
      "transparent": true,
      "type": "gauge"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "links": [],
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "light-yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 3,
        "x": 0,
        "y": 15
      },
      "hideTimeOverride": true,
      "id": 62,
      "interval": "0s",
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "vertical",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [],
          "fields": "/.*/",
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "value_and_name",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\ntoday_start = date.truncate(t: now(), unit: 1d)\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: today_start)\r\n  |> filter(fn: (r) =>\r\n    r._measurement == \"realtime\" and\r\n    r._field == \"Inverter\" and\r\n    r.endpoint == \"Power Ac\" and\r\n    r.unit == \"W\"\r\n  )\r\n  // CRUCIALE: Unisce tutte le serie in una sola tabella prima di cercare il max\r\n  |> group()\r\n  |> max()\r\n  |> map(fn: (r) => ({\r\n      ORARIO: \r\n        (if date.hour(t: r._time) < 10 then \"0\" else \"\") + string(v: date.hour(t: r._time)) + \":\" +\r\n        (if date.minute(t: r._time) < 10 then \"0\" else \"\") + string(v: date.minute(t: r._time)),\r\n      VALORE: r._value\r\n  }))",
          "refId": "Picco Produzione"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "0d/d",
      "title": "Picco di Produzione",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "links": [],
          "mappings": [],
          "noValue": "0 Wh",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "super-light-blue",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 3,
        "x": 3,
        "y": 15
      },
      "hideTimeOverride": true,
      "id": 61,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "vertical",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [],
          "fields": "/.*/",
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "value_and_name",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\ntoday_start = date.truncate(t: now(), unit: 1d)\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: today_start)\r\n  |> filter(fn: (r) =>\r\n    r._measurement == \"realtime\" and\r\n    r._field == \"Meter\" and\r\n    r.endpoint == \"Power\"\r\n  )\r\n  |> filter(fn: (r) => r._value > 0)\r\n  // CRUCIALE: Unisce tutte le serie in una sola tabella prima di cercare il max\r\n  |> group()\r\n  |> max()\r\n  |> map(fn: (r) => ({\r\n      ORARIO: \r\n        (if date.hour(t: r._time) < 10 then \"0\" else \"\") + string(v: date.hour(t: r._time)) + \":\" +\r\n        (if date.minute(t: r._time) < 10 then \"0\" else \"\") + string(v: date.minute(t: r._time)),\r\n      VALORE: r._value\r\n  }))",
          "refId": "Picco Massimo Immissione"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "0d/d",
      "title": "Picco di Immissione",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "links": [],
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "semi-dark-orange",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 3,
        "x": 6,
        "y": 15
      },
      "hideTimeOverride": true,
      "id": 70,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "vertical",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [],
          "fields": "/.*/",
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "value_and_name",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\n// import \"strings\" // Non serve più se non usi strings.substring\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\ntoday_start = date.truncate(t: now(), unit: 1d)\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: today_start)\r\n  |> filter(fn: (r) =>\r\n      r._measurement == \"realtime\" and\r\n      ((r._field == \"Inverter\" and r.endpoint == \"Power Ac\") or\r\n       (r._field == \"Meter\" and r.endpoint == \"Power\"))\r\n  )\r\n  |> aggregateWindow(every: 5s, fn: mean, createEmpty: false)\r\n  |> keep(columns: [\"_time\", \"_value\", \"_field\"])\r\n  |> pivot(rowKey:[\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\r\n  |> map(fn: (r) => ({\r\n      _time: r._time,\r\n      Produzione: if exists r.Inverter then r.Inverter else 0.0,\r\n      Rete: if exists r.Meter then r.Meter else 0.0,\r\n      // Assumendo Meter Positivo = Export\r\n      Consumo: (if exists r.Inverter then r.Inverter else 0.0) - (if exists r.Meter then r.Meter else 0.0)\r\n  }))\r\n  |> filter(fn: (r) => r.Consumo > 0.0)\r\n  |> max(column: \"Consumo\")\r\n  |> map(fn: (r) => ({\r\n      ORARIO: \r\n        (if date.hour(t: r._time) < 10 then \"0\" else \"\") + string(v: date.hour(t: r._time)) + \":\" +\r\n        (if date.minute(t: r._time) < 10 then \"0\" else \"\") + string(v: date.minute(t: r._time)),\r\n      VALORE: r.Consumo\r\n  }))",
          "refId": "Picco Consumo"
        }
      ],
      "timeFrom": "0d/d",
      "title": "Picco di Consumo",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "light-yellow",
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 3,
        "x": 9,
        "y": 15
      },
      "hideTimeOverride": true,
      "id": 69,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "/^Autoconsumo$/",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"array\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nstart = date.truncate(t: now(), unit: 1d)\r\nstop  = date.add(d: 1d, to: start)\r\n\r\n// Produzione: ultimo - primo\r\ndata_prod = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: start, stop: stop)\r\n  |> filter(fn: (r) =>\r\n      r._measurement == \"realtime\" and\r\n      r._field == \"Inverter\" and\r\n      r.endpoint == \"Energy Total\" and\r\n      r.unit == \"Wh\"\r\n  )\r\n\r\nfirst_prod = data_prod |> first() |> findRecord(fn: (key) => true, idx: 0)\r\nlast_prod = data_prod |> last() |> findRecord(fn: (key) => true, idx: 0)\r\nprod_value = last_prod._value - first_prod._value\r\n\r\n// Export: ultimo - primo\r\ndata_exp = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: start, stop: stop)\r\n  |> filter(fn: (r) =>\r\n      r._measurement == \"realtime\" and\r\n      r._field == \"Meter\" and\r\n      r.endpoint == \"Export Energy Active\" and\r\n      r.unit == \"Wh\"\r\n  )\r\n\r\nfirst_exp = data_exp |> first() |> findRecord(fn: (key) => true, idx: 0)\r\nlast_exp = data_exp |> last() |> findRecord(fn: (key) => true, idx: 0)\r\nexp_value = last_exp._value - first_exp._value\r\n\r\n// Autoconsumo = Produzione - Export\r\nautoconsumo = prod_value - exp_value\r\nautoconsumo_final = if autoconsumo < 0.0 then 0.0 else autoconsumo\r\n\r\n// Risultato\r\narray.from(rows: [{\r\n  _time: now(),\r\n  Autoconsumo: autoconsumo_final,\r\n  _field: \"autoconsumo_wh\"\r\n}])\r\n  |> yield(name: \"autoconsumo_wh\")",
          "refId": "Autoconsumo"
        }
      ],
      "timeFrom": "0d/d",
      "title": "Autoconsumo di oggi",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "light-yellow",
            "mode": "thresholds"
          },
          "mappings": [],
          "max": 100,
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 3,
        "x": 12,
        "y": 15
      },
      "hideTimeOverride": true,
      "id": 60,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "/^Perc_Autoconsumo_OGGI$/",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "value",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"array\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\ntoday_start = date.truncate(t: now(), unit: 1d)\r\n\r\n// Energia importata (prelievo)\r\ndata_importata = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: today_start)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"realtime\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"Import Energy Active\")\r\n  |> filter(fn: (r) => exists r._value)\r\n\r\nfirst_importata = data_importata |> first() |> findRecord(fn: (key) => true, idx: 0)\r\nlast_importata = data_importata |> last() |> findRecord(fn: (key) => true, idx: 0)\r\nimportata_value = last_importata._value - first_importata._value\r\n\r\n// Energia prodotta\r\ndata_prodotta = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: today_start)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"realtime\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Inverter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"Energy Total\")\r\n  |> filter(fn: (r) => exists r._value)\r\n\r\nfirst_prodotta = data_prodotta |> first() |> findRecord(fn: (key) => true, idx: 0)\r\nlast_prodotta = data_prodotta |> last() |> findRecord(fn: (key) => true, idx: 0)\r\nprodotta_value = last_prodotta._value - first_prodotta._value\r\n\r\n// Energia esportata\r\ndata_esportata = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: today_start)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"realtime\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"Export Energy Active\")\r\n  |> filter(fn: (r) => exists r._value)\r\n\r\nfirst_esportata = data_esportata |> first() |> findRecord(fn: (key) => true, idx: 0)\r\nlast_esportata = data_esportata |> last() |> findRecord(fn: (key) => true, idx: 0)\r\nesportata_value = last_esportata._value - first_esportata._value\r\n\r\n// Calcoli finali\r\nautoconsumo = prodotta_value - esportata_value\r\nconsumo_totale = importata_value + autoconsumo\r\nperc_autoconsumo = if consumo_totale > 0.0 then (autoconsumo / consumo_totale) * 100.0 else 0.0\r\n\r\n// Risultato\r\narray.from(rows: [{\r\n  _time: now(),\r\n  _field: \"percentuale_autoconsumo\",\r\n  autoconsumo_wh: autoconsumo,\r\n  consumo_totale_wh: consumo_totale,\r\n  Perc_Autoconsumo_OGGI: perc_autoconsumo,\r\n  Autoconsumo_Wh_Debug: autoconsumo,\r\n  Consumo_Totale_Wh_Debug: consumo_totale,\r\n  Production_Wh_Debug: prodotta_value,\r\n  Export_Wh_Debug: esportata_value\r\n}])",
          "refId": "% Autoconsumo"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "0d/d",
      "title": "Percentuale Autoconsumo",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "light-yellow",
            "mode": "thresholds"
          },
          "decimals": 3,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              }
            ]
          },
          "unit": "currencyEUR"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 3,
        "x": 15,
        "y": 15
      },
      "hideTimeOverride": true,
      "id": 180,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "/.*/",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"array\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nstart = date.truncate(t: now(), unit: 1d)\r\nstop = date.add(d: 1d, to: start)\r\nmonth_start = date.truncate(t: now(), unit: 1mo)\r\n\r\n// Recupera prezzo PUN medio mensile (già pre-calcolato)\r\nprezzo_pun = from(bucket: \"GME\")\r\n  |> range(start: month_start)\r\n  |> filter(fn: (r) => r._measurement == \"gme_monthly_avg\" and r._field == \"pun_kwh_avg\")\r\n  |> last()\r\n  |> findRecord(fn: (key) => true, idx: 0)\r\n\r\n// Produzione giornaliera\r\ndata_prod = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: start, stop: stop)\r\n  |> filter(fn: (r) => r._measurement == \"realtime\" and r._field == \"Inverter\" and r.endpoint == \"Energy Total\" and r.unit == \"Wh\")\r\n\r\nfirst_prod = data_prod |> first() |> findRecord(fn: (key) => true, idx: 0)\r\nlast_prod = data_prod |> last() |> findRecord(fn: (key) => true, idx: 0)\r\nprod_value = last_prod._value - first_prod._value\r\n\r\n// Export giornaliero\r\ndata_exp = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: start, stop: stop)\r\n  |> filter(fn: (r) => r._measurement == \"realtime\" and r._field == \"Meter\" and r.endpoint == \"Export Energy Active\" and r.unit == \"Wh\")\r\n\r\nfirst_exp = data_exp |> first() |> findRecord(fn: (key) => true, idx: 0)\r\nlast_exp = data_exp |> last() |> findRecord(fn: (key) => true, idx: 0)\r\nexp_value = last_exp._value - first_exp._value\r\n\r\n// Autoconsumo e risparmio\r\nautoconsumo = if (prod_value - exp_value) < 0.0 then 0.0 else (prod_value - exp_value)\r\nrisparmio = (autoconsumo / 1000.0) * prezzo_pun._value\r\n\r\narray.from(rows: [{PUN: prezzo_pun._value, Risparmio: risparmio}])\r\n",
          "refId": "Risparmio Autoconsumo"
        }
      ],
      "timeFrom": "0d/d",
      "title": "Risparmi Autoconsumo",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "decimals": 1,
          "mappings": [
            {
              "options": {
                "0": {
                  "color": "transparent",
                  "index": 0,
                  "text": "0  %"
                }
              },
              "type": "value"
            },
            {
              "options": {
                "from": 1,
                "result": {
                  "color": "dark-red",
                  "index": 1
                },
                "to": 50
              },
              "type": "range"
            },
            {
              "options": {
                "from": 51,
                "result": {
                  "color": "orange",
                  "index": 2
                },
                "to": 90
              },
              "type": "range"
            },
            {
              "options": {
                "from": 91,
                "result": {
                  "color": "green",
                  "index": 3
                },
                "to": 100
              },
              "type": "range"
            }
          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "rgb(240, 237, 236)",
                "value": 0
              }
            ]
          },
          "unit": " %"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 4,
        "x": 18,
        "y": 15
      },
      "hideTimeOverride": true,
      "id": 194,
      "maxDataPoints": 100,
      "options": {
        "colorMode": "background",
        "fieldOptions": {
          "calcs": [
            "mean"
          ]
        },
        "graphMode": "area",
        "justifyMode": "center",
        "orientation": "horizontal",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "/^Value$/",
          "values": false
        },
        "showPercentChange": false,
        "text": {
          "valueSize": 25
        },
        "textMode": "value",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"array\"\r\n\r\nac_value = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: -1h)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"realtime\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Inverter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"Power Ac\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> last()\r\n  |> findRecord(fn: (key) => true, idx: 0)\r\n\r\ndc_value = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: -1h)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"realtime\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Inverter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"Power Dc\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> last()\r\n  |> findRecord(fn: (key) => true, idx: 0)\r\n\r\narray.from(rows: [{\r\n  _time: now(),\r\n  _value: if dc_value._value > 0.0 then (ac_value._value / dc_value._value) * 100.0 else 0.0\r\n}])\r\n",
          "refId": "Efficienza"
        }
      ],
      "timeFrom": "0d/d",
      "title": "Efficienza",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Mixed --"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "Potenza (W)",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 40,
            "gradientMode": "opacity",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "watt"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Produzione"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#FADE2A",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Consumo_W"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#FF7383",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Immissione"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#5794F2",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Autoconsumo"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "green",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Sun altitude"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "yellow",
                  "mode": "fixed"
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 10
              },
              {
                "id": "custom.lineWidth",
                "value": 1
              },
              {
                "id": "unit",
                "value": "percent"
              },
              {
                "id": "custom.axisLabel",
                "value": "Altitudine Solare"
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [
                    5,
                    10
                  ],
                  "fill": "dash"
                }
              },
              {
                "id": "custom.axisPlacement",
                "value": "right"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "_time"
            },
            "properties": [
              {
                "id": "unit",
                "value": "time:HH:mm"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 12,
        "w": 12,
        "x": 0,
        "y": 18
      },
      "hideTimeOverride": true,
      "id": 183,
      "maxDataPoints": 2198,
      "options": {
        "legend": {
          "calcs": [
            "mean"
          ],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "tooltip": {
          "hideZeros": false,
          "maxHeight": 600,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\ntoday_start = date.truncate(t: now(), unit: 1d)\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: today_start)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"realtime\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Inverter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"Power Ac\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  // RIMOSSO aggregateWindow: ora vedi ogni singolo punto scritto nel DB\r\n  |> map(fn: (r) => ({\r\n    _time: r._time,\r\n    \"Produzione\": r._value\r\n  }))\r\n  // Opzionale: yield per mostrare subito il risultato\r\n  |> yield(name: \"Produzione_Raw\")",
          "refId": "Produzione"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\ntoday_start = date.truncate(t: now(), unit: 1d)\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: today_start)\r\n  |> filter(fn: (r) =>\r\n      r._measurement == \"realtime\" and\r\n      ((r._field == \"Inverter\" and r.endpoint == \"Power Ac\") or\r\n       (r._field == \"Meter\" and r.endpoint == \"Power\"))\r\n  )\r\n  // TRUCCO: Finestra di 1 secondo (o 5s se la tua frequenza è 5s).\r\n  // Questo NON fa media (perché cè 1 solo dato), ma allinea i timestamp\r\n  // così il pivot funziona e possiamo calcolare la differenza.\r\n  |> aggregateWindow(every: 5s, fn: mean, createEmpty: false)\r\n  \r\n  |> keep(columns: [\"_time\", \"_value\", \"_field\"])\r\n  |> pivot(rowKey:[\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\r\n  \r\n  // Calcolo Consumo sui dati praticamente grezzi\r\n  |> map(fn: (r) => ({\r\n      _time: r._time,\r\n      _value: (if exists r.Inverter then r.Inverter else 0.0) - (if exists r.Meter then r.Meter else 0.0)\r\n  }))\r\n  |> filter(fn: (r) => r._value >= 0.0)\r\n  |> rename(columns: {_value: \"Consumo_W\"})\r\n  |> yield(name: \"consumo_raw\")",
          "refId": "Consumo"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\ntoday_start = date.truncate(t: now(), unit: 1d)\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: today_start)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"realtime\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"Power\")\r\n  // Nessuna aggregazione, dati grezzi\r\n  |> map(fn: (r) => ({\r\n      _time: r._time,\r\n      // Se è negativo (prelievo) mettiamo 0, altrimenti teniamo il valore (immissione)\r\n      \"Immissione\": if r._value < 0.0 then 0.0 else r._value\r\n    }))\r\n  // Opzionale: filtrare via gli zeri per alleggerire il grafico se vuoi vedere solo quando immetti davvero\r\n  // |> filter(fn: (r) => r.Immissione > 0.0)\r\n  |> yield(name: \"immissione_raw\")",
          "refId": "Immissione"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\ntoday_start = date.truncate(t: now(), unit: 1d)\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: today_start)\r\n  |> filter(fn: (r) =>\r\n      r._measurement == \"realtime\" and\r\n      ((r._field == \"Inverter\" and r.endpoint == \"Power Ac\") or\r\n       (r._field == \"Meter\" and r.endpoint == \"Power\"))\r\n  )\r\n  // Allineamento temporale (fondamentale per calcoli tra serie diverse)\r\n  |> aggregateWindow(every: 5s, fn: mean, createEmpty: false)\r\n  \r\n  // Pivot invece di Join\r\n  |> keep(columns: [\"_time\", \"_value\", \"_field\"])\r\n  |> pivot(rowKey:[\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\r\n  \r\n  // Calcolo Autoconsumo\r\n  |> map(fn: (r) => ({\r\n      _time: r._time,\r\n      _prod: if exists r.Inverter then r.Inverter else 0.0,\r\n      _meter: if exists r.Meter then r.Meter else 0.0\r\n  }))\r\n  |> map(fn: (r) => ({\r\n      _time: r._time,\r\n      Autoconsumo: if r._meter >= 0.0 \r\n                   then r._prod - r._meter  // Se esporto: Prod - Export\r\n                   else r._prod             // Se importo: Tutto quello che produco lo consumo\r\n  }))\r\n  // Filtro valori negativi spuri (non dovrebbe succedere, ma per sicurezza)\r\n  |> filter(fn: (r) => r.Autoconsumo >= 0.0)\r\n  |> yield(name: \"autoconsumo_ottimizzato\")",
          "refId": "Autoconsumo"
        },
        {
          "datasource": {
            "type": "fetzerch-sunandmoon-datasource",
            "uid": "df27vpmtnxatcf"
          },
          "hide": false,
          "query": "",
          "refId": "A",
          "target": [
            "sun_altitude"
          ]
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "0d/d",
      "title": "Produzione - Consumo - Autoconsumo - Prelievo - Immissione (Oggi)",
      "transparent": true,
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Mixed --"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "Potenza (W)",
            "axisPlacement": "left",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 40,
            "gradientMode": "opacity",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "watt"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Produzione"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#FADE2A",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Consumo_W"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#FF7383",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Immissione"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#5794F2",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Autoconsumo"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "green",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Sun altitude"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "yellow",
                  "mode": "fixed"
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 8
              },
              {
                "id": "custom.lineWidth",
                "value": 1
              },
              {
                "id": "unit",
                "value": "percent"
              },
              {
                "id": "custom.axisLabel",
                "value": "Altitudine Solare"
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [
                    10,
                    10
                  ],
                  "fill": "dash"
                }
              },
              {
                "id": "custom.axisPlacement",
                "value": "right"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 12,
        "w": 12,
        "x": 12,
        "y": 18
      },
      "hideTimeOverride": true,
      "id": 181,
      "maxDataPoints": 2198,
      "options": {
        "legend": {
          "calcs": [
            "mean"
          ],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "tooltip": {
          "hideZeros": false,
          "maxHeight": 600,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nyesterday_start = date.truncate(t: date.sub(d: 1d, from: now()), unit: 1d)\r\nyesterday_end = date.add(d: 1d, to: yesterday_start)\r\n\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: yesterday_start, stop: yesterday_end)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"realtime\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Inverter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"Power Ac\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> aggregateWindow(every: 1m, fn: mean, createEmpty: false)\r\n  |> map(fn: (r) => ({\r\n    _time: r._time,\r\n    \"Produzione\": r._value\r\n  }))\r\n",
          "refId": "Produzione"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nyesterday_start = date.truncate(t: date.sub(d: 1d, from: now()), unit: 1d)\r\nyesterday_end = date.add(d: 1d, to: yesterday_start)\r\n\r\nproduzione = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: yesterday_start, stop: yesterday_end)\r\n  |> filter(fn: (r) => \r\n      r._measurement == \"realtime\" and\r\n      r._field == \"Inverter\" and\r\n      r.endpoint == \"Power Ac\"\r\n  )\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> aggregateWindow(every: 1m, fn: mean, createEmpty: false)\r\n  |> map(fn: (r) => ({_time: r._time, _value: r._value, _field: \"prod\"}))\r\n\r\nmeter = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: yesterday_start, stop: yesterday_end)\r\n  |> filter(fn: (r) => \r\n      r._measurement == \"realtime\" and\r\n      r._field == \"Meter\" and\r\n      r.endpoint == \"Power\"\r\n  )\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> aggregateWindow(every: 1m, fn: mean, createEmpty: false)\r\n  |> map(fn: (r) => ({_time: r._time, _value: r._value, _field: \"meter\"}))\r\n\r\n// Join e calcola consumo con formula corretta\r\njoin(tables: {prod: produzione, met: meter}, on: [\"_time\"])\r\n  |> map(fn: (r) => ({\r\n      _time: r._time,\r\n      _value: if r._value_met >= 0.0 \r\n              then r._value_prod - r._value_met\r\n              else r._value_prod + (r._value_met * -1.0)\r\n  }))\r\n  |> filter(fn: (r) => r._value >= 0.0)\r\n  |> rename(columns: {_value: \"Consumo_W\"})\r\n  |> yield(name: \"consumo_istantaneo_ieri\")\r\n",
          "refId": "Consumo"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nyesterday_start = date.truncate(t: date.sub(d: 1d, from: now()), unit: 1d)\r\nyesterday_end = date.add(d: 1d, to: yesterday_start)\r\n\r\nfrom(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: yesterday_start, stop: yesterday_end)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"realtime\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"Power\")\r\n  |> aggregateWindow(every: 1m, fn: mean, createEmpty: false)\r\n  |> map(fn: (r) => ({\r\n      _time: r._time,\r\n      \"Immissione\": if r._value < 0.0 then 0.0 else r._value\r\n    }))\r\n",
          "refId": "Immissione"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nyesterday_start = date.truncate(t: date.sub(d: 1d, from: now()), unit: 1d)\r\nyesterday_end = date.add(d: 1d, to: yesterday_start)\r\n\r\nproduzione = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: yesterday_start, stop: yesterday_end)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"realtime\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Inverter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"Power Ac\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> aggregateWindow(every: 1m, fn: mean, createEmpty: false)\r\n  |> map(fn: (r) => ({ r with _field: \"produzione\" }))\r\n\r\nimmissione = from(bucket: \"Solaredge_Realtime\")\r\n  |> range(start: yesterday_start, stop: yesterday_end)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"realtime\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"Power\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> aggregateWindow(every: 1m, fn: mean, createEmpty: false)\r\n  |> map(fn: (r) => ({ r with _field: \"immissione\" }))\r\n\r\njoin(tables: {prod: produzione, imm: immissione}, on: [\"_time\"])\r\n  |> map(fn: (r) => ({\r\n    _time: r._time,\r\n    \"Autoconsumo\": if r._value_imm >= 0.0 then r._value_prod - r._value_imm else r._value_prod\r\n  }))\r\n  |> filter(fn: (r) => r.Autoconsumo >= 0)\r\n",
          "refId": "Autoconsumo"
        },
        {
          "datasource": {
            "type": "fetzerch-sunandmoon-datasource",
            "uid": "df27vpmtnxatcf"
          },
          "hide": false,
          "latitude": "40.8199",
          "longitude": "14.3413",
          "refId": "A",
          "target": [
            "sun_altitude"
          ]
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "1d/d",
      "title": "Produzione - Consumo - Autoconsumo - Prelievo - Immissione (Ieri)",
      "transparent": true,
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "Energia (KWh)",
            "axisPlacement": "auto",
            "fillOpacity": 80,
            "gradientMode": "hue",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "decimals": 2,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watt"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Produzione"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Consumo"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Autoconsumo"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-green",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Prelievo"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-red",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Immissione"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "blue",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 14,
        "w": 23,
        "x": 0,
        "y": 30
      },
      "id": 6,
      "options": {
        "barRadius": 0,
        "barWidth": 0.97,
        "fullHighlight": false,
        "groupWidth": 0.9,
        "legend": {
          "calcs": [
            "mean"
          ],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "orientation": "auto",
        "showValue": "always",
        "stacking": "none",
        "tooltip": {
          "hideZeros": false,
          "maxHeight": 600,
          "mode": "single",
          "sort": "none"
        },
        "xField": "Time",
        "xTickLabelRotation": 0,
        "xTickLabelSpacing": 100
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\noption location = timezone.location(name: \"Europe/Rome\")\n\nfrom(bucket: \"Solaredge\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\n  |> filter(fn: (r) => r[\"metric\"] == \"Production\")\n  |> aggregateWindow(every: 1d, fn: sum, createEmpty: true)\n  |> timeShift(duration: -1s, columns: [\"_time\"])\n  |> fill(value: 0.0)\n  |> map(fn: (r) => ({ r with _field: \"Produzione\" }))\n  |> keep(columns: [\"_time\", \"_value\", \"_field\"])",
          "refId": "Produzione"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\noption location = timezone.location(name: \"Europe/Rome\")\n\n// Consumption (disponibile di giorno)\nconsumption = from(bucket: \"Solaredge\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\n  |> filter(fn: (r) => r[\"metric\"] == \"Consumption\")\n  |> aggregateWindow(every: 1d, fn: sum, createEmpty: false)\n  |> timeShift(duration: -1s, columns: [\"_time\"])\n  |> map(fn: (r) => ({_time: r._time, _value: r._value, _field: \"Consumo\"}))\n\n// Purchased (fallback per la notte)\npurchased = from(bucket: \"Solaredge\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\n  |> filter(fn: (r) => r[\"metric\"] == \"Purchased\")\n  |> aggregateWindow(every: 1d, fn: sum, createEmpty: false)\n  |> timeShift(duration: -1s, columns: [\"_time\"])\n  |> map(fn: (r) => ({_time: r._time, _value: r._value, _field: \"Consumo\"}))\n\n// Unisci - Consumption ha priorità, Purchased riempie i buchi\nunion(tables: [consumption, purchased])\n  |> sort(columns: [\"_time\", \"_value\"], desc: true)\n  |> unique(column: \"_time\")\n  |> keep(columns: [\"_time\", \"_value\", \"_field\"])\n",
          "refId": "Consumo"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\noption location = timezone.location(name: \"Europe/Rome\")\n\n// SelfConsumption (disponibile di giorno)\nselfConsumption = from(bucket: \"Solaredge\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\n  |> filter(fn: (r) => r[\"metric\"] == \"SelfConsumption\")\n  |> aggregateWindow(every: 1d, fn: sum, createEmpty: false)\n  |> timeShift(duration: -1s, columns: [\"_time\"])\n  |> map(fn: (r) => ({_time: r._time, _value: r._value, _field: \"Autoconsumo\"}))\n\n// Fallback 0 per la notte (usa Production che ha sempre lo 0 a mezzanotte)\nzeroFallback = from(bucket: \"Solaredge\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\n  |> filter(fn: (r) => r[\"metric\"] == \"Production\")\n  |> aggregateWindow(every: 1d, fn: sum, createEmpty: false)\n  |> timeShift(duration: -1s, columns: [\"_time\"])\n  |> map(fn: (r) => ({_time: r._time, _value: 0.0, _field: \"Autoconsumo\"}))\n\n// Unisci - SelfConsumption ha priorità, 0 riempie i buchi\nunion(tables: [selfConsumption, zeroFallback])\n  |> sort(columns: [\"_time\", \"_value\"], desc: true)\n  |> unique(column: \"_time\")\n  |> keep(columns: [\"_time\", \"_value\", \"_field\"])\n",
          "refId": "Autoconsumo"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\noption location = timezone.location(name: \"Europe/Rome\")\n\nfrom(bucket: \"Solaredge\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\n  |> filter(fn: (r) => r[\"metric\"] == \"Purchased\")\n  |> aggregateWindow(every: 1d, fn: sum, createEmpty: true)\n  |> timeShift(duration: -1s, columns: [\"_time\"])\n  |> fill(value: 0.0)\n  |> map(fn: (r) => ({ r with _field: \"Prelievo\" }))\n  |> keep(columns: [\"_time\", \"_value\", \"_field\"])",
          "refId": "Prelievo"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\noption location = timezone.location(name: \"Europe/Rome\")\n\nfrom(bucket: \"Solaredge\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\n  |> filter(fn: (r) => r[\"metric\"] == \"FeedIn\")\n  |> aggregateWindow(every: 1d, fn: sum, createEmpty: true)\n  |> timeShift(duration: -1s, columns: [\"_time\"])\n  |> fill(value: 0.0)\n  |> map(fn: (r) => ({ r with _field: \"Immissione\" }))\n  |> keep(columns: [\"_time\", \"_value\", \"_field\"])",
          "refId": "Immissione"
        }
      ],
      "title": "Produzione - Consumo - Autoconsumo - Prelievo - Immissione (Periodo Selezionato)",
      "type": "barchart"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "displayName": "Produzione",
          "mappings": [],
          "noValue": "Produzione 0kWh",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": ""
            },
            "properties": []
          }
        ]
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 30
      },
      "id": 121,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "alias": "Produzione",
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Production\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> aggregateWindow(every: 1d, fn: sum, createEmpty: false)\r\n  |> yield(name: \"Produzione\")\r\n",
          "rawQuery": true,
          "refId": "Produzione",
          "resultFormat": "time_series"
        }
      ],
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "orange",
            "mode": "fixed"
          },
          "displayName": "Consumo",
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 32
      },
      "id": 122,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "vertical",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\n// Consumption (disponibile di giorno)\r\nconsumption = from(bucket: \"Solaredge\")\r\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Consumption\")\r\n  |> aggregateWindow(every: 1d, fn: sum, createEmpty: false)\r\n  |> timeShift(duration: -1s, columns: [\"_time\"])\r\n  |> map(fn: (r) => ({_time: r._time, _value: r._value, _field: \"Consumo\"}))\r\n\r\n// Purchased (fallback per la notte)\r\npurchased = from(bucket: \"Solaredge\")\r\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Purchased\")\r\n  |> aggregateWindow(every: 1d, fn: sum, createEmpty: false)\r\n  |> timeShift(duration: -1s, columns: [\"_time\"])\r\n  |> map(fn: (r) => ({_time: r._time, _value: r._value, _field: \"Consumo\"}))\r\n\r\n// Unisci - Consumption ha priorità, Purchased riempie i buchi\r\nunion(tables: [consumption, purchased])\r\n  |> sort(columns: [\"_time\", \"_value\"], desc: true)\r\n  |> unique(column: \"_time\")\r\n  |> keep(columns: [\"_time\", \"_value\", \"_field\"])\r\n",
          "refId": "Consumo"
        }
      ],
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "dark-green",
            "mode": "fixed"
          },
          "displayName": "Autoconsumo",
          "mappings": [],
          "noValue": "Autoconsumo 0kWh",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 34
      },
      "id": 123,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"SelfConsumption\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> aggregateWindow(every: 1d, fn: sum, createEmpty: false)\r\n  |> yield(name: \"Autoconsumo\")\r\n",
          "refId": "Autoconsumo"
        }
      ],
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "dark-red",
            "mode": "fixed"
          },
          "displayName": "Prelievo",
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 36
      },
      "id": 124,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Purchased\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> aggregateWindow(every: 1d, fn: sum, createEmpty: false)\r\n  |> yield(name: \"Prelievo\")\r\n",
          "refId": "Prelievo"
        }
      ],
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "blue",
            "mode": "fixed"
          },
          "displayName": "Immissione",
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 38
      },
      "id": 125,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"FeedIn\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> aggregateWindow(every: 1d, fn: sum, createEmpty: false)\r\n  |> yield(name: \"Immissione\")\r\n",
          "refId": "Immissione"
        }
      ],
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Mixed --"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "light-yellow",
            "mode": "thresholds"
          },
          "displayName": "% Autoconsumo",
          "mappings": [],
          "max": 100,
          "min": 0,
          "noValue": "Autoconsumo 0%",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 40
      },
      "id": 144,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nselfconsumption = from(bucket: \"Solaredge\")\r\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"SelfConsumption\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n  |> map(fn: (r) => ({ _time: now(), _value: r._value, _field: \"selfconsumption\" }))\r\n\r\npurchased = from(bucket: \"Solaredge\")\r\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Purchased\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n  |> map(fn: (r) => ({ _time: now(), _value: r._value, _field: \"purchased\" }))\r\n\r\nunion(tables: [selfconsumption, purchased])\r\n  |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\r\n  |> map(fn: (r) => ({\r\n      _time: r._time,\r\n      _value: if (r.selfconsumption + r.purchased) > 0.0 \r\n              then (r.selfconsumption / (r.selfconsumption + r.purchased)) * 100.0 \r\n              else 0.0\r\n  }))\r\n",
          "refId": "% Autoconsumo"
        }
      ],
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Mixed --"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "light-yellow",
            "mode": "thresholds"
          },
          "displayName": "% Prelievo",
          "mappings": [],
          "max": 100,
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-red",
                "value": 0
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 42
      },
      "id": 172,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": false
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\npurchased = from(bucket: \"Solaredge\")\r\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Purchased\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n  |> map(fn: (r) => ({ _time: now(), _value: r._value, _field: \"purchased\" }))\r\n\r\nconsumption = from(bucket: \"Solaredge\")\r\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Consumption\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n  |> map(fn: (r) => ({ _time: now(), _value: r._value, _field: \"consumption\" }))\r\n\r\nunion(tables: [purchased, consumption])\r\n  |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\r\n  |> map(fn: (r) => ({\r\n      _time: r._time,\r\n      _value: if r.consumption > 0.0 \r\n              then (r.purchased / r.consumption) * 100.0 \r\n              else 100.0\r\n  }))\r\n",
          "refId": "A"
        }
      ],
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "Energia (KWh)",
            "axisPlacement": "auto",
            "axisSoftMin": 0,
            "fillOpacity": 83,
            "gradientMode": "hue",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "decimals": 2,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "watt"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Produzione"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Consumo"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Autoconsumo"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-green",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Prelievo"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-red",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Immissione"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "blue",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 14,
        "w": 23,
        "x": 0,
        "y": 44
      },
      "id": 72,
      "options": {
        "barRadius": 0,
        "barWidth": 0.97,
        "fullHighlight": false,
        "groupWidth": 0.65,
        "legend": {
          "calcs": [
            "mean"
          ],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "orientation": "auto",
        "showValue": "auto",
        "stacking": "none",
        "tooltip": {
          "hideZeros": false,
          "maxHeight": 600,
          "mode": "single",
          "sort": "none"
        },
        "xField": "Time",
        "xTickLabelMaxLength": 0,
        "xTickLabelRotation": 0,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nstartOfYear = date.truncate(t: now(), unit: 1y)\r\nendOfYear = date.add(d: 1y, to: startOfYear)\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(start: startOfYear, stop: endOfYear)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\" and r[\"_field\"] == \"Meter\" and r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Production\" or r[\"metric\"] == \"Consumption\" or r[\"metric\"] == \"SelfConsumption\" or r[\"metric\"] == \"Purchased\" or r[\"metric\"] == \"FeedIn\")\r\n  |> aggregateWindow(every: 1mo, fn: sum, createEmpty: true, offset: -1s)\r\n  |> fill(value: 0.0)\r\n  |> map(fn: (r) => ({ r with _field: if r.metric == \"Production\" then \"Produzione\"\r\n      else if r.metric == \"Consumption\" then \"Consumo\"\r\n      else if r.metric == \"SelfConsumption\" then \"Autoconsumo\"\r\n      else if r.metric == \"Purchased\" then \"Prelievo\"\r\n      else if r.metric == \"FeedIn\" then \"Immissione\"\r\n      else r._field\r\n  }))\r\n  |> filter(fn: (r) => r._time < endOfYear)\r\n  |> drop(columns: [\"metric\", \"_start\", \"_stop\", \"endpoint\", \"unit\", \"_measurement\"])\r\n  |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\r\n",
          "refId": "Statistiche Anno Corrente"
        }
      ],
      "title": "Produzione - Consumo - Autoconsumo - Prelievo - Immissione (Anno Corrente)",
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": {
              "_time": false
            },
            "includeByName": {},
            "indexByName": {
              "Autoconsumo": 3,
              "Consumo": 2,
              "Immissione": 5,
              "Prelievo": 4,
              "Produzione": 1,
              "_time": 0
            },
            "renameByName": {}
          }
        }
      ],
      "transparent": true,
      "type": "barchart"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "displayName": "Produzione",
          "mappings": [],
          "noValue": "Produzione 0kWh",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": ""
            },
            "properties": []
          }
        ]
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 44
      },
      "hideTimeOverride": true,
      "id": 173,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "alias": "Produzione",
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(start: date.truncate(t: now(), unit: 1y))\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Production\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n",
          "rawQuery": true,
          "refId": "Produzione",
          "resultFormat": "time_series"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "0y/y",
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "orange",
            "mode": "fixed"
          },
          "displayName": "Consumo",
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 46
      },
      "hideTimeOverride": true,
      "id": 174,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "vertical",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(start: date.truncate(t: now(), unit: 1y))\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Consumption\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n",
          "refId": "Consumo"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "0y/y",
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "dark-green",
            "mode": "fixed"
          },
          "displayName": "Autoconsumo",
          "mappings": [],
          "noValue": "Autoconsumo 0kWh",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 48
      },
      "hideTimeOverride": true,
      "id": 175,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(start: date.truncate(t: now(), unit: 1y))\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"SelfConsumption\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n",
          "refId": "Autoconsumo"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "0y/y",
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "dark-red",
            "mode": "fixed"
          },
          "displayName": "Prelievo",
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 50
      },
      "hideTimeOverride": true,
      "id": 176,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(start: date.truncate(t: now(), unit: 1y))\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Purchased\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n",
          "refId": "Prelievo"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "0y/y",
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "blue",
            "mode": "fixed"
          },
          "displayName": "Immissione",
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 52
      },
      "hideTimeOverride": true,
      "id": 178,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(start: date.truncate(t: now(), unit: 1y))\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"FeedIn\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n",
          "refId": "Immissione"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "0y/y",
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Mixed --"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "light-yellow",
            "mode": "thresholds"
          },
          "displayName": "% Autoconsumo",
          "mappings": [],
          "max": 100,
          "min": 0,
          "noValue": "Autoconsumo 0%",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 54
      },
      "hideTimeOverride": true,
      "id": 190,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": false
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nselfconsumption = from(bucket: \"Solaredge\")\r\n  |> range(start: date.truncate(t: now(), unit: 1y))\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"SelfConsumption\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n  |> map(fn: (r) => ({ _time: now(), _value: r._value, _field: \"selfconsumption\" }))\r\n\r\npurchased = from(bucket: \"Solaredge\")\r\n  |> range(start: date.truncate(t: now(), unit: 1y))\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Purchased\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n  |> map(fn: (r) => ({ _time: now(), _value: r._value, _field: \"purchased\" }))\r\n\r\nunion(tables: [selfconsumption, purchased])\r\n  |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\r\n  |> map(fn: (r) => ({\r\n      _time: r._time,\r\n      _value: (r.selfconsumption / (r.selfconsumption + r.purchased)) * 100.0\r\n  }))\r\n",
          "refId": "% Autoconsumo"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "0y/y",
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Mixed --"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "light-yellow",
            "mode": "thresholds"
          },
          "mappings": [],
          "max": 100,
          "min": 0,
          "noValue": "Prelievo 100%",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-red",
                "value": 0
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 56
      },
      "hideTimeOverride": true,
      "id": 177,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": false
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"array\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\npurchased = from(bucket: \"Solaredge\")\r\n  |> range(start: date.truncate(t: now(), unit: 1y))\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Purchased\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n  |> findRecord(fn: (key) => true, idx: 0)\r\n\r\nconsumption = from(bucket: \"Solaredge\")\r\n  |> range(start: date.truncate(t: now(), unit: 1y))\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Consumption\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n  |> findRecord(fn: (key) => true, idx: 0)\r\n\r\nprelievo = purchased._value / consumption._value * 100.0\r\n\r\narray.from(rows: [{_value: prelievo}])\r\n",
          "refId": "% Prelievo"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "0y/y",
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "Energia (KWh)",
            "axisPlacement": "auto",
            "axisSoftMin": 0,
            "fillOpacity": 83,
            "gradientMode": "hue",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "watt"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Produzione"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Consumo"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Autoconsumo"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-green",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Prelievo"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-red",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Immissione"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "blue",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 14,
        "w": 23,
        "x": 0,
        "y": 58
      },
      "hideTimeOverride": true,
      "id": 162,
      "interval": "1d",
      "maxDataPoints": 3,
      "options": {
        "barRadius": 0,
        "barWidth": 0.97,
        "fullHighlight": false,
        "groupWidth": 0.65,
        "legend": {
          "calcs": [
            "mean"
          ],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "orientation": "auto",
        "showValue": "auto",
        "stacking": "none",
        "tooltip": {
          "hideZeros": false,
          "maxHeight": 600,
          "mode": "single",
          "sort": "none"
        },
        "xField": "Time",
        "xTickLabelMaxLength": 0,
        "xTickLabelRotation": 0,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nstartOfLastYear = date.sub(d: 1y, from: date.truncate(t: now(), unit: 1y))\r\nendOfLastYear = date.truncate(t: now(), unit: 1y)\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(start: startOfLastYear, stop: endOfLastYear)\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\" and r[\"_field\"] == \"Meter\" and r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Production\" or r[\"metric\"] == \"Consumption\" or r[\"metric\"] == \"SelfConsumption\" or r[\"metric\"] == \"Purchased\" or r[\"metric\"] == \"FeedIn\")\r\n  |> aggregateWindow(every: 1mo, fn: sum, createEmpty: true, offset: -1s)\r\n  |> fill(value: 0.0)\r\n  |> map(fn: (r) => ({ r with _field: \r\n      if r.metric == \"Production\" then \"Produzione\"\r\n      else if r.metric == \"Consumption\" then \"Consumo\"\r\n      else if r.metric == \"SelfConsumption\" then \"Autoconsumo\"\r\n      else if r.metric == \"Purchased\" then \"Prelievo\"\r\n      else if r.metric == \"FeedIn\" then \"Immissione\"\r\n      else r._field\r\n  }))\r\n  |> filter(fn: (r) => r._time < endOfLastYear)\r\n  |> drop(columns: [\"metric\", \"_start\", \"_stop\", \"endpoint\", \"unit\", \"_measurement\"])\r\n  |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\r\n",
          "refId": "Anno Precedente"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "1y/y",
      "title": "Produzione - Consumo - Autoconsumo - Prelievo - Immissione (Anno Precedente)",
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": {},
            "includeByName": {},
            "indexByName": {
              "Autoconsumo": 3,
              "Consumo": 2,
              "Immissione": 5,
              "Prelievo": 4,
              "Produzione": 1,
              "_time": 0
            },
            "renameByName": {}
          }
        }
      ],
      "type": "barchart"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "displayName": "Produzione",
          "mappings": [],
          "noValue": "Produzione 0kWh",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": ""
            },
            "properties": []
          }
        ]
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 58
      },
      "hideTimeOverride": true,
      "id": 185,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "alias": "Produzione",
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"experimental\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(\r\n      start: experimental.subDuration(d: 1y, from: date.truncate(t: now(), unit: 1y)),\r\n      stop: date.truncate(t: now(), unit: 1y)\r\n  )\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Production\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n",
          "rawQuery": true,
          "refId": "Produzione",
          "resultFormat": "time_series"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "1y/y",
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "orange",
            "mode": "fixed"
          },
          "displayName": "Consumo",
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 60
      },
      "hideTimeOverride": true,
      "id": 186,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"experimental\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(\r\n      start: experimental.subDuration(d: 1y, from: date.truncate(t: now(), unit: 1y)),\r\n      stop: date.truncate(t: now(), unit: 1y)\r\n  )\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Consumption\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n",
          "refId": "Consumo"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "1y/y",
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "dark-green",
            "mode": "fixed"
          },
          "displayName": "Autoconsumo",
          "mappings": [],
          "noValue": "Autoconsumo 0kWh",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 62
      },
      "hideTimeOverride": true,
      "id": 187,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"experimental\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(\r\n      start: experimental.subDuration(d: 1y, from: date.truncate(t: now(), unit: 1y)),\r\n      stop: date.truncate(t: now(), unit: 1y)\r\n  )\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"SelfConsumption\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n",
          "refId": "Autoconsumo"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "1y/y",
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "dark-red",
            "mode": "fixed"
          },
          "displayName": "Prelievo",
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 64
      },
      "hideTimeOverride": true,
      "id": 188,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"experimental\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(\r\n      start: experimental.subDuration(d: 1y, from: date.truncate(t: now(), unit: 1y)),\r\n      stop: date.truncate(t: now(), unit: 1y)\r\n  )\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Purchased\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n",
          "refId": "Prelievo"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "1y/y",
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "blue",
            "mode": "fixed"
          },
          "displayName": "Immissione",
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "yellow",
                "value": 0
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 66
      },
      "hideTimeOverride": true,
      "id": 189,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"experimental\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(\r\n      start: experimental.subDuration(d: 1y, from: date.truncate(t: now(), unit: 1y)),\r\n      stop: date.truncate(t: now(), unit: 1y)\r\n  )\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"FeedIn\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n",
          "refId": "Immissione"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "1y/y",
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Mixed --"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "light-yellow",
            "mode": "thresholds"
          },
          "displayName": "% Autoconsumo",
          "mappings": [],
          "max": 100,
          "min": 0,
          "noValue": "Autoconsumo 0%",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 68
      },
      "hideTimeOverride": true,
      "id": 179,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"experimental\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nselfconsumption = from(bucket: \"Solaredge\")\r\n  |> range(\r\n      start: experimental.subDuration(d: 1y, from: date.truncate(t: now(), unit: 1y)),\r\n      stop: date.truncate(t: now(), unit: 1y)\r\n  )\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"SelfConsumption\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n  |> map(fn: (r) => ({ _time: now(), _value: r._value, _field: \"selfconsumption\" }))\r\n\r\npurchased = from(bucket: \"Solaredge\")\r\n  |> range(\r\n      start: experimental.subDuration(d: 1y, from: date.truncate(t: now(), unit: 1y)),\r\n      stop: date.truncate(t: now(), unit: 1y)\r\n  )\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Purchased\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n  |> map(fn: (r) => ({ _time: now(), _value: r._value, _field: \"purchased\" }))\r\n\r\nunion(tables: [selfconsumption, purchased])\r\n  |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\r\n  |> map(fn: (r) => ({\r\n      _time: r._time,\r\n      _value: (r.selfconsumption / (r.selfconsumption + r.purchased)) * 100.0\r\n  }))\r\n",
          "refId": "% Autoconsumo Anno Precedente"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "1y/y",
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Mixed --"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "light-yellow",
            "mode": "thresholds"
          },
          "displayName": "% Prelievo",
          "mappings": [],
          "max": 100,
          "min": 0,
          "noValue": "Prelievo 100%",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-red",
                "value": 0
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 1,
        "x": 23,
        "y": 70
      },
      "hideTimeOverride": true,
      "id": 191,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "sum"
          ],
          "fields": "",
          "limit": 1,
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": false
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"experimental\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\npurchased = from(bucket: \"Solaredge\")\r\n  |> range(\r\n      start: experimental.subDuration(d: 1y, from: date.truncate(t: now(), unit: 1y)),\r\n      stop: date.truncate(t: now(), unit: 1y)\r\n  )\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Purchased\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n  |> map(fn: (r) => ({ _time: now(), _value: r._value, _field: \"purchased\" }))\r\n\r\nconsumption = from(bucket: \"Solaredge\")\r\n  |> range(\r\n      start: experimental.subDuration(d: 1y, from: date.truncate(t: now(), unit: 1y)),\r\n      stop: date.truncate(t: now(), unit: 1y)\r\n  )\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Meter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_details\")\r\n  |> filter(fn: (r) => r[\"metric\"] == \"Consumption\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> sum()\r\n  |> map(fn: (r) => ({ _time: now(), _value: r._value, _field: \"consumption\" }))\r\n\r\nunion(tables: [purchased, consumption])\r\n  |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\r\n  |> map(fn: (r) => ({\r\n      _time: r._time,\r\n      _value: (r.purchased / r.consumption) * 100.0\r\n  }))\r\n",
          "refId": "% Prelievo Anno Precedente"
        }
      ],
      "timeFrom": "0d/d",
      "timeShift": "1y/y",
      "title": "",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": true,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "kWh",
            "axisPlacement": "auto",
            "fillOpacity": 83,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "watth"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 12,
        "w": 24,
        "x": 0,
        "y": 72
      },
      "hideTimeOverride": true,
      "id": 193,
      "options": {
        "barRadius": 0,
        "barWidth": 0.97,
        "fullHighlight": false,
        "groupWidth": 0.65,
        "legend": {
          "calcs": [
            "sum"
          ],
          "displayMode": "list",
          "placement": "right",
          "showLegend": true
        },
        "orientation": "auto",
        "showValue": "never",
        "stacking": "none",
        "text": {
          "valueSize": 14
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        },
        "xField": "month_name",
        "xTickLabelRotation": 0,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\nfrom(bucket: \"Solaredge\")\r\n  |> range(start: 0, stop: now())\r\n  |> filter(fn: (r) => r[\"_measurement\"] == \"api\")\r\n  |> filter(fn: (r) => r[\"_field\"] == \"Inverter\")\r\n  |> filter(fn: (r) => r[\"endpoint\"] == \"site_energy_day\")\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> map(fn: (r) => ({ \r\n      r with \r\n      year: string(v: date.year(t: r._time)),\r\n      month: date.month(t: r._time)\r\n  }))\r\n  |> group(columns: [\"year\", \"month\"])\r\n  |> sum(column: \"_value\")\r\n  |> map(fn: (r) => ({\r\n      r with\r\n      month_name: if r.month == 1 then \"Gennaio\"\r\n        else if r.month == 2 then \"Febbraio\"\r\n        else if r.month == 3 then \"Marzo\"\r\n        else if r.month == 4 then \"Aprile\"\r\n        else if r.month == 5 then \"Maggio\"\r\n        else if r.month == 6 then \"Giugno\"\r\n        else if r.month == 7 then \"Luglio\"\r\n        else if r.month == 8 then \"Agosto\"\r\n        else if r.month == 9 then \"Settembre\"\r\n        else if r.month == 10 then \"Ottobre\"\r\n        else if r.month == 11 then \"Novembre\"\r\n        else \"Dicembre\"\r\n  }))\r\n  |> group()\r\n  |> pivot(rowKey: [\"month\", \"month_name\"], columnKey: [\"year\"], valueColumn: \"_value\")\r\n  |> sort(columns: [\"month\"])\r\n  |> drop(columns: [\"month\"])\r\n",
          "rawQuery": true,
          "refId": "A"
        }
      ],
      "timeFrom": "30y",
      "title": "Produzione Annuale Storica",
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": {},
            "includeByName": {},
            "indexByName": {
              "2021": 1,
              "2022": 2,
              "2023": 3,
              "2024": 4,
              "2025": 5,
              "month_name": 0
            },
            "renameByName": {}
          }
        }
      ],
      "type": "barchart"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Mixed --"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "Potenza (W)",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "opacity",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 2,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "min": 0,
          "noValue": "Modalita Notturna Nessuna Produzione",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "watt"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Sun altitude"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#FADE2A",
                  "mode": "fixed"
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 10
              },
              {
                "id": "custom.lineWidth",
                "value": 1
              },
              {
                "id": "unit",
                "value": "percent"
              },
              {
                "id": "custom.axisLabel",
                "value": "Altitudine Solare"
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [
                    5,
                    10
                  ],
                  "fill": "dash"
                }
              },
              {
                "id": "custom.axisPlacement",
                "value": "right"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 14,
        "w": 24,
        "x": 0,
        "y": 84
      },
      "id": 99,
      "interval": "15m",
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "table",
          "placement": "right",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "fetzerch-sunandmoon-datasource",
            "uid": "df27vpmtnxatcf"
          },
          "hide": true,
          "refId": "A",
          "target": [
            "sun_altitude"
          ]
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\n// Dati reali\r\nreal_data = from(bucket: \"Solaredge\")\r\n    |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\r\n    |> filter(fn: (r) => r[\"_measurement\"] == \"web\")\r\n    |> filter(fn: (r) => r[\"_field\"] == \"Optimizer group\")\r\n    |> filter(fn: (r) => r[\"endpoint\"] == \"PRODUCTION_POWER\")\r\n    |> aggregateWindow(every: 15m, fn: last, createEmpty: false)\r\n\r\n// Trova primo e ultimo dato con gestione sicura\r\nfirst_record = real_data |> first() |> findRecord(fn: (key) => true, idx: 0)\r\nlast_record = real_data |> last() |> findRecord(fn: (key) => true, idx: 0)\r\n\r\n// Gestione sicura del controllo produzione finita\r\nnow_time = now()\r\nproduction_ended = if exists last_record._time then\r\n    int(v: now_time) - int(v: last_record._time) > 1800000000000  // 30 minuti\r\nelse\r\n    true  // Se non ci sono dati, considera produzione finita\r\n\r\n// Timeline completa\r\nfrom(bucket: \"Solaredge\")\r\n    |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\r\n    |> filter(fn: (r) => r[\"_measurement\"] == \"web\")\r\n    |> filter(fn: (r) => r[\"_field\"] == \"Optimizer group\")\r\n    |> filter(fn: (r) => r[\"endpoint\"] == \"PRODUCTION_POWER\")\r\n    |> aggregateWindow(every: 15m, fn: last, createEmpty: true)\r\n    |> map(fn: (r) => {\r\n        value = if not exists first_record._time then\r\n            0.0  // Nessun dato disponibile\r\n        else if r._time < first_record._time then\r\n            0.0  // Prima del primo dato\r\n        else if exists last_record._time and r._time > last_record._time and production_ended then\r\n            0.0  // Dopo l'ultimo dato e produzione finita\r\n        else\r\n            r._value\r\n        \r\n        return {\r\n            _time: r._time,\r\n            _value: value,\r\n            device_id: r.device_id\r\n        }\r\n    })\r\n    |> filter(fn: (r) => exists r._value)\r\n    |> map(fn: (r) => ({\r\n        _time: r._time, \r\n        _value: r._value, \r\n        _field: r.device_id\r\n    }))\r\n    |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\r\n",
          "refId": "Potenza Pannelli Istantanea"
        }
      ],
      "title": "Potenza Pannelli (Range Selezionato)",
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": {
              "10° Pannello 375W": false,
              "11° Pannello 375W": false,
              "12° Pannello 375W": false,
              "13° Pannello 375W": true,
              "14° Pannello 375W": true,
              "15° Pannello 375W": true,
              "16° Pannello 375W": true,
              "1° Pannello 375W": false,
              "21830A42-F0": false,
              "2183101D-D1": false,
              "218315ED-A6": false,
              "2183174C-07": false,
              "2183174E-09": false,
              "21831750-0B": false,
              "218317DB-96": false,
              "218317DC-97": false,
              "218317E0-9B": false,
              "21831855-11": false,
              "21831859-15": false,
              "2183185A-16": false,
              "2183185D-19": false,
              "21831860-1C": false,
              "21831861-1D": false,
              "21831863-1F": false,
              "2° Pannello 375W": false,
              "3° Pannello 375W": true,
              "4° Pannello 375W": false,
              "5° Pannello 375W": false,
              "6° Pannello 375W": true,
              "7° Pannello 375W": true,
              "8° Pannello 375W": true,
              "9° Pannello 375W": true
            },
            "includeByName": {},
            "indexByName": {
              "21830A42-F0": 1,
              "2183101D-D1": 2,
              "218315ED-A6": 9,
              "2183174C-07": 3,
              "2183174E-09": 4,
              "21831750-0B": 10,
              "218317DB-96": 11,
              "218317DC-97": 12,
              "218317E0-9B": 13,
              "21831855-11": 5,
              "21831859-15": 7,
              "2183185A-16": 8,
              "2183185D-19": 6,
              "21831860-1C": 14,
              "21831861-1D": 15,
              "21831863-1F": 16,
              "_time": 0
            },
            "orderBy": [
              {
                "desc": false,
                "type": "name"
              }
            ],
            "orderByMode": "manual",
            "renameByName": {
              "21831855-11": ""
            }
          }
        }
      ],
      "transparent": true,
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Mixed --"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "decimals": 1,
          "mappings": [],
          "max": 400,
          "min": 0,
          "noValue": "Modalita Notturna Nessuna Produzione",
          "thresholds": {
            "mode": "percentage",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "#EAB839",
                "value": 50
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "watt"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 14,
        "w": 24,
        "x": 0,
        "y": 98
      },
      "id": 154,
      "options": {
        "displayMode": "gradient",
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "maxVizHeight": 300,
        "minVizHeight": 10,
        "minVizWidth": 0,
        "namePlacement": "auto",
        "orientation": "horizontal",
        "reduceOptions": {
          "calcs": [
            "max"
          ],
          "fields": "",
          "values": false
        },
        "showUnfilled": true,
        "sizing": "auto",
        "text": {},
        "valueMode": "color"
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\n// Conta dati grezzi prima di aggregare\r\nraw_data = from(bucket: \"Solaredge\")\r\n    |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\r\n    |> filter(fn: (r) => r[\"_measurement\"] == \"web\")\r\n    |> filter(fn: (r) => r[\"_field\"] == \"Optimizer group\")\r\n    |> filter(fn: (r) => r[\"endpoint\"] == \"PRODUCTION_POWER\")\r\n\r\ncount_check = raw_data \r\n    |> count() \r\n    |> group()\r\n    |> sum()\r\n    |> findRecord(fn: (key) => true, idx: 0)\r\n\r\n// Query dati aggregati solo se esistono\r\ndata = if exists count_check._value and count_check._value > 0 then\r\n    raw_data\r\n        |> aggregateWindow(every: 15m, fn: last, createEmpty: true)\r\n        |> fill(column: \"_value\", value: 0.0)\r\nelse\r\n    // Dataset vuoto invece di dummy\r\n    raw_data |> limit(n: 0)\r\n\r\n// Processa solo se ci sono dati\r\ndata\r\n    |> filter(fn: (r) => exists r._value)  // Filtra eventuali valori null\r\n    |> map(fn: (r) => ({\r\n        _time: r._time,\r\n        _value: r._value,\r\n        _field: r.device_id\r\n    }))\r\n    |> group()\r\n    |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\r\n",
          "refId": "B"
        }
      ],
      "title": "Potenza Picco Pannelli (Range Selezionato)",
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": {},
            "includeByName": {},
            "indexByName": {
              "21830A42-F0": 1,
              "2183101D-D1": 2,
              "218315ED-A6": 14,
              "2183174C-07": 3,
              "2183174E-09": 4,
              "21831750-0B": 10,
              "218317DB-96": 16,
              "218317DC-97": 13,
              "218317E0-9B": 12,
              "21831855-11": 5,
              "21831859-15": 6,
              "2183185A-16": 7,
              "2183185D-19": 8,
              "21831860-1C": 9,
              "21831861-1D": 11,
              "21831863-1F": 15,
              "_time": 0
            },
            "renameByName": {
              "value {id=\"182492143\", name=\"panel\", site=\"2489781\"}": "Potenza Totale",
              "w {id=\"182492143\", name=\"panel\", site=\"2489781\"}": "Picco Totale Pannelli",
              "w {id=\"182492144\", name=\"panel\", site=\"2489781\"}": "1° Pannello 375W Ovest",
              "w {id=\"182492145\", name=\"panel\", site=\"2489781\"}": "2° Pannello 375W Ovest",
              "w {id=\"182492146\", name=\"panel\", site=\"2489781\"}": "3° Pannello 375W Ovest",
              "w {id=\"182492147\", name=\"panel\", site=\"2489781\"}": "4° Pannello 375W Ovest",
              "w {id=\"182492148\", name=\"panel\", site=\"2489781\"}": "5° Pannello 375W Ovest",
              "w {id=\"182492149\", name=\"panel\", site=\"2489781\"}": "6° Pannello 375W Ovest",
              "w {id=\"182492150\", name=\"panel\", site=\"2489781\"}": "7° Pannello 375W Ovest",
              "w {id=\"182492156\", name=\"panel\", site=\"2489781\"}": "8° Pannello 375W Ovest",
              "w {id=\"182492157\", name=\"panel\", site=\"2489781\"}": "1° Pannello 375W Est",
              "w {id=\"182492158\", name=\"panel\", site=\"2489781\"}": "2° Pannello 375W Est",
              "w {id=\"182492160\", name=\"panel\", site=\"2489781\"}": "3° Pannello 375W Est",
              "w {id=\"182492161\", name=\"panel\", site=\"2489781\"}": "4° Pannello 375W Est",
              "w {id=\"182492162\", name=\"panel\", site=\"2489781\"}": "5° Pannello 375W Est",
              "w {id=\"182492163\", name=\"panel\", site=\"2489781\"}": "6° Pannello 375W Est",
              "w {id=\"182492164\", name=\"panel\", site=\"2489781\"}": "7° Pannello 375W Est",
              "w {id=\"182492167\", name=\"panel\", site=\"2489781\"}": "8° Pannello 375W Est"
            }
          }
        }
      ],
      "transparent": true,
      "type": "bargauge"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "light-yellow",
            "mode": "fixed"
          },
          "decimals": 2,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "light-red",
                "value": 0
              }
            ]
          },
          "unit": "kwatth"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Immissione"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "light-blue",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Emissioni CO2 Evitate"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "purple",
                  "mode": "fixed"
                }
              },
              {
                "id": "unit",
                "value": "massg"
              },
              {
                "id": "decimals",
                "value": 2
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Prelievo"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-red",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Autoconsumo"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-green",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Consumo"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              },
              {
                "id": "unit",
                "value": "kwatth"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 3,
        "w": 24,
        "x": 0,
        "y": 112
      },
      "hideTimeOverride": true,
      "id": 58,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "last"
          ],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "text": {
          "titleSize": 27,
          "valueSize": 27
        },
        "textMode": "value_and_name",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\n// Fattore emissioni: 0.4 kg CO2 per kWh prodotto\r\nemission_factor_kg_per_kwh = 0.4\r\n\r\n// Produzione (kWh)\r\nprod = from(bucket: \"Solaredge\")\r\n  |> range(start: 0, stop: now())\r\n  |> filter(fn: (r) => \r\n      r._measurement == \"api\" and \r\n      r._field == \"Meter\" and \r\n      r.endpoint == \"site_energy_details\" and \r\n      r.metric == \"Production\"\r\n  )\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> group()\r\n  |> sum(column: \"_value\")\r\n  |> map(fn: (r) => ({ r with _j: \"k\", Produzione: r._value / 1000.0 }))\r\n  |> keep(columns: [\"_j\", \"Produzione\"])\r\n\r\n// Immissione (kWh)\r\nfeed = from(bucket: \"Solaredge\")\r\n  |> range(start: 0, stop: now())\r\n  |> filter(fn: (r) => \r\n      r._measurement == \"api\" and \r\n      r._field == \"Meter\" and \r\n      r.endpoint == \"site_energy_details\" and \r\n      r.metric == \"FeedIn\"\r\n  )\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> group()\r\n  |> sum(column: \"_value\")\r\n  |> map(fn: (r) => ({ r with _j: \"k\", Immissione: r._value / 1000.0 }))\r\n  |> keep(columns: [\"_j\", \"Immissione\"])\r\n\r\n// Prelievo (kWh)\r\npurch = from(bucket: \"Solaredge\")\r\n  |> range(start: 0, stop: now())\r\n  |> filter(fn: (r) => \r\n      r._measurement == \"api\" and \r\n      r._field == \"Meter\" and \r\n      r.endpoint == \"site_energy_details\" and \r\n      r.metric == \"Purchased\"\r\n  )\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> group()\r\n  |> sum(column: \"_value\")\r\n  |> map(fn: (r) => ({ r with _j: \"k\", Prelievo: r._value / 1000.0 }))\r\n  |> keep(columns: [\"_j\", \"Prelievo\"])\r\n\r\n// Consumo (kWh)\r\ncons = from(bucket: \"Solaredge\")\r\n  |> range(start: 0, stop: now())\r\n  |> filter(fn: (r) => \r\n      r._measurement == \"api\" and \r\n      r._field == \"Meter\" and \r\n      r.endpoint == \"site_energy_details\" and \r\n      r.metric == \"Consumption\"\r\n  )\r\n  |> filter(fn: (r) => exists r._value)\r\n  |> group()\r\n  |> sum(column: \"_value\")\r\n  |> map(fn: (r) => ({ r with _j: \"k\", Consumo: r._value / 1000.0 }))\r\n  |> keep(columns: [\"_j\", \"Consumo\"])\r\n\r\n// Join a catena su _j\r\nj1 = join(tables: {a: prod, b: feed}, on: [\"_j\"])\r\nj2 = join(tables: {a: j1, b: purch}, on: [\"_j\"])\r\nj3 = join(tables: {a: j2, b: cons}, on: [\"_j\"])\r\n\r\n// Derivati: Autoconsumo (kWh) e Emissioni CO2 Evitate (kg)\r\nj3\r\n  |> map(fn: (r) => ({\r\n      r with\r\n      Autoconsumo: r.Consumo - r.Prelievo,\r\n      EmissioniCO2Evitate: r.Produzione * emission_factor_kg_per_kwh\r\n  }))\r\n  |> rename(columns: {EmissioniCO2Evitate: \"Emissioni CO2 Evitate\"})\r\n  |> keep(columns: [\"Produzione\", \"Immissione\", \"Prelievo\", \"Consumo\", \"Autoconsumo\", \"Emissioni CO2 Evitate\"])\r\n",
          "refId": "Statistiche"
        }
      ],
      "timeFrom": "0d/d",
      "title": "Riepilogo Energia - Vita Impianto",
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": {},
            "includeByName": {},
            "indexByName": {
              "Autoconsumo": 2,
              "Consumo": 1,
              "Emissioni CO2 Evitate": 5,
              "Immissione": 4,
              "Prelievo": 3,
              "Produzione": 0
            },
            "renameByName": {}
          }
        }
      ],
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff27vpmruzxtsc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "decimals": 0,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              },
              {
                "color": "dark-red",
                "value": 0
              }
            ]
          },
          "unit": "€"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Costo Prelievo Con Fotovoltaico"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Rimborsi Immissione"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "blue",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Guadagno Netto"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "green",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 3,
        "w": 24,
        "x": 0,
        "y": 115
      },
      "id": 192,
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "/.*/",
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "value_and_name",
        "wideLayout": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"join\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\n// 1. Consumo mensile\r\nconsumo = from(bucket: \"Solaredge\")\r\n  |> range(start: 0)\r\n  |> filter(fn: (r) => r._measurement == \"api\" and r._field == \"Meter\" and r.endpoint == \"site_energy_details\" and r.metric == \"Consumption\")\r\n  |> aggregateWindow(every: 1mo, fn: sum, createEmpty: false)\r\n  |> group()\r\n  |> map(fn: (r) => ({_time: r._time, year: string(v: date.year(t: r._time)), month: string(v: date.month(t: r._time)), consumo_wh: r._value}))\r\n\r\n// 2. PUN mensile\r\npun = from(bucket: \"GME\")\r\n  |> range(start: 0)\r\n  |> filter(fn: (r) => r._measurement == \"gme_monthly_avg\" and r._field == \"pun_kwh_avg\")\r\n  |> group()\r\n  |> map(fn: (r) => ({_time: r._time, year: r.year, month: string(v: date.month(t: r._time)), pun: r._value}))\r\n\r\n// 3. Join, calcola costo e somma totale\r\njoin.inner(\r\n  left: consumo,\r\n  right: pun,\r\n  on: (l, r) => l.year == r.year and l.month == r.month,\r\n  as: (l, r) => ({\r\n    _time: l._time,\r\n    \"Costo Senza Fotovoltaico\": (l.consumo_wh / 1000.0) * r.pun\r\n  })\r\n)\r\n  |> sum(column: \"Costo Senza Fotovoltaico\")\r\n",
          "refId": "Costo Senza Fotovoltaico"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"join\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\n// 1. Prelievo mensile (energia acquistata dalla rete)\r\nprelievo = from(bucket: \"Solaredge\")\r\n  |> range(start: 0)\r\n  |> filter(fn: (r) => r._measurement == \"api\" and r._field == \"Meter\" and r.endpoint == \"site_energy_details\" and r.metric == \"Purchased\")\r\n  |> aggregateWindow(every: 1mo, fn: sum, createEmpty: false)\r\n  |> group()\r\n  |> map(fn: (r) => ({_time: r._time, year: string(v: date.year(t: r._time)), month: string(v: date.month(t: r._time)), prelievo_wh: r._value}))\r\n\r\n// 2. PUN mensile\r\npun = from(bucket: \"GME\")\r\n  |> range(start: 0)\r\n  |> filter(fn: (r) => r._measurement == \"gme_monthly_avg\" and r._field == \"pun_kwh_avg\")\r\n  |> group()\r\n  |> map(fn: (r) => ({_time: r._time, year: r.year, month: string(v: date.month(t: r._time)), pun: r._value}))\r\n\r\n// 3. Join, calcola costo e somma totale\r\njoin.inner(\r\n  left: prelievo,\r\n  right: pun,\r\n  on: (l, r) => l.year == r.year and l.month == r.month,\r\n  as: (l, r) => ({\r\n    _time: l._time,\r\n    \"Costo Prelievo Con Fotovoltaico\": (l.prelievo_wh / 1000.0) * r.pun\r\n  })\r\n)\r\n  |> sum(column: \"Costo Prelievo Con Fotovoltaico\")\r\n",
          "refId": "Costo Con Fotovoltaico"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff27vpmruzxtsc"
          },
          "hide": false,
          "query": "import \"timezone\"\r\nimport \"date\"\r\nimport \"join\"\r\n\r\noption location = timezone.location(name: \"Europe/Rome\")\r\n\r\n// 1. Immissione mensile (energia venduta alla rete)\r\nimmissione = from(bucket: \"Solaredge\")\r\n  |> range(start: 0)\r\n  |> filter(fn: (r) => r._measurement == \"api\" and r._field == \"Meter\" and r.endpoint == \"site_energy_details\" and r.metric == \"FeedIn\")\r\n  |> aggregateWindow(every: 1mo, fn: sum, createEmpty: false)\r\n  |> group()\r\n  |> map(fn: (r) => ({_time: r._time, year: string(v: date.year(t: r._time)), month: string(v: date.month(t: r._time)), immissione_wh: r._value}))\r\n\r\n// 2. PUN mensile\r\npun = from(bucket: \"GME\")\r\n  |> range(start: 0)\r\n  |> filter(fn: (r) => r._measurement == \"gme_monthly_avg\" and r._field == \"pun_kwh_avg\")\r\n  |> group()\r\n  |> map(fn: (r) => ({_time: r._time, year: r.year, month: string(v: date.month(t: r._time)), pun: r._value}))\r\n\r\n// 3. Join, calcola rimborso e somma totale\r\njoin.inner(\r\n  left: immissione,\r\n  right: pun,\r\n  on: (l, r) => l.year == r.year and l.month == r.month,\r\n  as: (l, r) => ({\r\n    _time: l._time,\r\n    \"Rimborsi Immissione\": (l.immissione_wh / 1000.0) * r.pun\r\n  })\r\n)\r\n  |> sum(column: \"Rimborsi Immissione\")\r\n",
          "refId": "Rimborsi Immissione"
        },
        {
          "datasource": {
            "name": "Expression",
            "type": "__expr__",
            "uid": "__expr__"
          },
          "expression": "${Costo Senza Fotovoltaico} - ${Costo Con Fotovoltaico} + ${Rimborsi Immissione}",
          "hide": false,
          "refId": "Guadagno Netto",
          "type": "math"
        }
      ],
      "title": "Riepilogo SSP - Vita Impianto",
      "transparent": true,
      "type": "stat"
    }
  ],
  "preload": false,
  "refresh": "5s",
  "schemaVersion": 42,
  "tags": [],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now/d",
    "to": "now/d"
  },
  "timepicker": {},
  "timezone": "",
  "title": "Solaredge 3.0",
  "uid": "afb91a6f-d8f7-43ae-8a98-67eab1bb4baa",
  "version": 422,
  "weekStart": "monday"
}